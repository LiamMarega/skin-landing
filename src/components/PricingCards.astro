---
import ModernCard from "./ui/ModernCard.astro";

// Supabase Edge Function URL
const SUPABASE_URL = "https://gljypypgwkihblvbeftd.supabase.co";
---

<section
    id="pricing"
    class="relative w-full py-24 bg-black text-white font-sans overflow-hidden"
>
    <!-- Background Effects -->
    <div class="absolute inset-0 pointer-events-none">
        <div
            class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-900/20 rounded-full blur-[120px]"
        >
        </div>
        <div
            class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-900/20 rounded-full blur-[120px]"
        >
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 relative z-10">
        <div class="grid md:grid-cols-2 gap-8 lg:gap-16 items-stretch">
            <!-- Plan B√°sico -->
            <ModernCard
                bgClass="bg-zinc-900"
                shadowClass="bg-blue-600"
                borderClass="border-blue-500/30"
                class="h-full"
            >
                <div class="flex flex-col h-full">
                    <!-- Header -->
                    <div class="mb-8 text-center">
                        <h3
                            class="text-2xl font-black uppercase tracking-wider mb-2"
                        >
                            Plan B√°sico
                        </h3>
                        <p
                            class="text-blue-400 font-semibold tracking-widest text-sm mb-6"
                        >
                            (Nivel T√©cnico + Sistema)
                        </p>

                        <div class="flex items-center justify-center gap-4">
                            <div class="relative">
                                <span
                                    class="text-6xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400"
                                    >$300</span
                                >
                                <span
                                    class="block text-sm font-bold text-gray-400 mt-1"
                                    >USD</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <ul class="space-y-4 mb-8 grow font-medium">
                        <li class="flex items-start gap-3">
                            <span class="text-green-400 mt-1">‚úî</span>
                            <span class="text-gray-300">
                                <strong class="text-white">TODO EL MES</strong> (4
                                clases en vivo + 4 grabadas).
                            </span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-green-400 mt-1">‚úî</span>
                            <span class="text-gray-300">
                                Sistema de dise√±o + correcciones grupales en
                                vivo.
                            </span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-green-400 mt-1">‚úî</span>
                            <span class="text-gray-300">
                                Sal√≠s con <strong class="text-white"
                                    >PORTFOLIO + OFERTA</strong
                                > lista.
                            </span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-green-400 mt-1">‚úî</span>
                            <span class="text-gray-300">
                                Acceso a comunidad y grabaciones de por vida.
                            </span>
                        </li>
                    </ul>

                    <!-- CTA -->
                    <button
                        type="button"
                        data-plan="basic"
                        class="pricing-btn block w-full py-4 bg-white text-black font-black text-center uppercase tracking-widest hover:bg-gray-200 transition-colors rounded-xl disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span class="btn-text">Quiero el B√°sico</span>
                        <span class="btn-loading hidden">
                            <svg
                                class="animate-spin h-5 w-5 mx-auto"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </ModernCard>

            <!-- Plan Pro -->
            <ModernCard
                bgClass="bg-zinc-900"
                shadowClass="bg-yellow-500"
                borderClass="border-yellow-400"
                class="mt-8 md:mt-0 h-full"
            >
                <div class="flex flex-col h-full relative overflow-hidden">
                    <!-- Rocket Sticker -->
                    <div
                        class="absolute -top-6 -right-6 text-6xl transform rotate-12 drop-shadow-2xl filter brightness-110"
                    >
                        üöÄ
                    </div>

                    <!-- Header -->
                    <div class="mb-8 text-center relative z-10">
                        <h3
                            class="text-2xl font-black uppercase tracking-wider mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500"
                        >
                            Plan Pro
                        </h3>
                        <p
                            class="text-yellow-500/80 font-semibold tracking-widest text-sm mb-6"
                        >
                            (Acompa√±amiento 1:1)
                        </p>

                        <div class="flex items-center justify-center gap-4">
                            <div class="relative">
                                <span
                                    class="text-6xl font-black bg-clip-text text-transparent bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-600 drop-shadow-[0_0_10px_rgba(234,179,8,0.3)]"
                                    >$600</span
                                >
                                <span
                                    class="block text-sm font-bold text-yellow-500/80 mt-1"
                                    >USD</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <ul class="space-y-4 mb-8 relative z-10 grow font-medium">
                        <li class="flex items-start gap-3">
                            <span class="text-yellow-400 mt-1">‚òÖ</span>
                            <span class="text-gray-300">
                                <strong class="text-white"
                                    >TODO LO DEL PLAN B√ÅSICO</strong
                                > incluido.
                            </span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-yellow-400 mt-1">‚òÖ</span>
                            <span class="text-gray-300">
                                <strong class="text-yellow-400"
                                    >2 LLAMADAS 1:1</strong
                                > (45 min c/u) para estrategia personal.
                            </span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-yellow-400 mt-1">‚òÖ</span>
                            <span class="text-gray-300">
                                Revisi√≥n + armado de tu <strong
                                    class="text-yellow-400"
                                    >OFERTA y PACK</strong
                                > (para cerrar ventas).
                            </span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-yellow-400 mt-1">‚òÖ</span>
                            <span class="text-gray-300">
                                Prioridad total para destrabar dudas clave.
                            </span>
                        </li>
                    </ul>

                    <!-- CTA -->
                    <button
                        type="button"
                        data-plan="pro"
                        class="pricing-btn block w-full py-4 bg-gradient-to-r from-yellow-400 to-yellow-600 text-black font-black text-center uppercase tracking-widest hover:from-yellow-300 hover:to-yellow-500 transition-all shadow-[0_0_20px_rgba(234,179,8,0.3)] rounded-xl relative z-10 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span class="btn-text">Quiero el Pro</span>
                        <span class="btn-loading hidden">
                            <svg
                                class="animate-spin h-5 w-5 mx-auto"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </ModernCard>
        </div>

        <!-- Guarantee Section -->
        <div class="mt-16 max-w-3xl mx-auto text-center space-y-6">
            <h4
                class="text-2xl md:text-3xl font-bold text-white uppercase italic"
            >
                Garant√≠a Condicionada ("Yo te acompa√±o")
            </h4>
            <div
                class="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl relative overflow-hidden group hover:border-zinc-700 transition-colors"
            >
                <div
                    class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"
                >
                </div>
                <p
                    class="text-gray-300 text-lg md:text-xl font-medium relative z-10"
                >
                    "Si complet√°s las tareas de las primeras 2 semanas y sent√≠s
                    que no mejoraste, te doy una <span
                        class="text-yellow-400 font-bold"
                        >llamada 1:1 de 30 min</span
                    > para destrabar."
                </p>
                <p
                    class="text-sm text-gray-500 mt-4 relative z-10 uppercase tracking-widest"
                >
                    Compromiso mutuo: Yo te doy el sistema, vos pon√©s la
                    pr√°ctica.
                </p>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <dialog id="emailModal" class="bg-transparent">
        <div
            class="bg-zinc-900 border border-zinc-700 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl"
        >
            <h3 class="text-2xl font-bold text-white mb-2">¬°Un paso m√°s!</h3>
            <p class="text-gray-400 mb-6">
                Ingres√° tu email para continuar con el pago
            </p>

            <form id="emailForm" class="space-y-4">
                <input
                    type="email"
                    id="customerEmail"
                    placeholder="tu@email.com"
                    required
                    class="w-full px-4 py-3 bg-zinc-800 border border-zinc-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition-colors"
                />

                <div class="flex gap-3">
                    <button
                        type="button"
                        id="cancelBtn"
                        class="flex-1 py-3 bg-zinc-700 text-white font-semibold rounded-xl hover:bg-zinc-600 transition-colors"
                    >
                        Cancelar
                    </button>
                    <button
                        type="submit"
                        id="submitBtn"
                        class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-xl hover:from-blue-400 hover:to-purple-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span class="submit-text">Continuar al Pago</span>
                        <span class="submit-loading hidden">
                            <svg
                                class="animate-spin h-5 w-5 mx-auto"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </span>
                    </button>
                </div>

                <p
                    id="errorMsg"
                    class="text-red-400 text-sm text-center hidden"
                >
                </p>
            </form>
        </div>
    </dialog>
</section>

<script define:vars={{ SUPABASE_URL }}>
    // State
    let selectedPlan = null;

    // Elements
    const modal = document.getElementById("emailModal");
    const emailForm = document.getElementById("emailForm");
    const emailInput = document.getElementById("customerEmail");
    const cancelBtn = document.getElementById("cancelBtn");
    const submitBtn = document.getElementById("submitBtn");
    const errorMsg = document.getElementById("errorMsg");
    const pricingBtns = document.querySelectorAll(".pricing-btn");

    // Open modal when clicking pricing buttons
    pricingBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            selectedPlan = btn.dataset.plan;
            errorMsg.classList.add("hidden");
            emailInput.value = "";
            modal.showModal();
        });
    });

    // Close modal on cancel
    cancelBtn.addEventListener("click", () => {
        modal.close();
        selectedPlan = null;
    });

    // Close modal on backdrop click
    modal.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.close();
            selectedPlan = null;
        }
    });

    // Handle form submission
    emailForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = emailInput.value.trim();
        if (!email || !selectedPlan) return;

        // Disable buttons and show loading
        setLoading(true);
        errorMsg.classList.add("hidden");

        try {
            const response = await fetch(
                `${SUPABASE_URL}/functions/v1/create-preference`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        plan_type: selectedPlan,
                        email: email,
                    }),
                },
            );

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Error al procesar el pago");
            }

            if (data.sandbox_init_point || data.init_point) {
                // Use sandbox for testing, fallback to production
                const checkoutUrl = data.sandbox_init_point || data.init_point;
                console.log("Redirecting to:", checkoutUrl);
                window.location.href = checkoutUrl;
            } else {
                throw new Error("No se recibi√≥ el link de pago");
            }
        } catch (error) {
            console.error("Payment error:", error);
            errorMsg.textContent =
                error.message ||
                "Ocurri√≥ un error. Por favor, intent√° de nuevo.";
            errorMsg.classList.remove("hidden");
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        cancelBtn.disabled = isLoading;
        emailInput.disabled = isLoading;

        const submitText = submitBtn.querySelector(".submit-text");
        const submitLoading = submitBtn.querySelector(".submit-loading");

        if (isLoading) {
            submitText.classList.add("hidden");
            submitLoading.classList.remove("hidden");
        } else {
            submitText.classList.remove("hidden");
            submitLoading.classList.add("hidden");
        }
    }
</script>

<style>
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
    }

    dialog[open] {
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
