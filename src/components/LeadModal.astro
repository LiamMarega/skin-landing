---
// Supabase Edge Function URL
const SUPABASE_URL = "https://gljypypgwkihblvbeftd.supabase.co";
---

<!-- 
    Main Modal Container 
    Default strict state: HIDDEN (display: none).
    We add 'flex' via JS when opening.
-->
<div
    id="leadModal"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    class="hidden fixed z-50 inset-0 scale-z-90 w-screen h-full overflow-hidden outline-none focus:outline-none bg-black/50 backdrop-blur-sm"
>
    <!-- Modal Content Wrapper -->
    <!-- Centering wrapper: This will become active when parent is flex -->
    <div class="relative w-screen h-full justify-center flex items-center p-4">
        <!-- Actual Modal Box -->
        <div
            class="relative w-full max-w-lg bg-[#0a0a0a] border border-white/10 p-8 md:p-10 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 modal-card"
            style="clip-path: polygon(3% 0%, 100% 0%, 97% 100%, 0% 100%);"
        >
            <!-- Background Texture -->
            <div
                class="absolute inset-0 bg-[url('/assets/resoures/textures/texture_02.webp')] opacity-10 mix-blend-overlay pointer-events-none"
            >
            </div>

            <!-- Close Button -->
            <button
                id="closeModalBtn"
                class="absolute top-4 right-6 text-zinc-500 hover:text-white transition-colors z-50 p-2 cursor-pointer"
                type="button"
                aria-label="Cerrar modal"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="lucide lucide-x"
                    ><path d="M18 6 6 18"></path><path d="m6 6 12 12"
                    ></path></svg
                >
            </button>

            <!-- Header -->
            <h3
                class="text-3xl md:text-5xl font-black text-white mb-2 uppercase italic text-center relative z-10 tracking-tighter"
            >
                ¡UN PASO MÁS!
            </h3>
            <p
                class="text-zinc-400 mb-8 font-medium text-center text-sm md:text-base relative z-10 uppercase tracking-widest opacity-80"
            >
                Completá tus datos para asegurar tu lugar.
            </p>

            <!-- Form -->
            <form id="leadForm" class="space-y-5 relative z-10">
                <!-- Full Name -->
                <div class="space-y-1">
                    <label
                        for="leadName"
                        class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.2em] ml-1"
                        >NOMBRE COMPLETO <span class="text-accent">*</span
                        ></label
                    >
                    <input
                        type="text"
                        id="leadName"
                        required
                        class="w-full px-5 py-4 bg-zinc-900/40 border border-zinc-800 text-white placeholder-zinc-700 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all uppercase font-bold tracking-wide text-sm"
                        style="font-family: 'Aniko', sans-serif;"
                        placeholder="TU NOMBRE"
                    />
                </div>

                <!-- Email -->
                <div class="space-y-1">
                    <label
                        for="leadEmail"
                        class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.2em] ml-1"
                        >EMAIL <span class="text-accent">*</span></label
                    >
                    <input
                        type="email"
                        id="leadEmail"
                        required
                        class="w-full px-5 py-4 bg-zinc-900/40 border border-zinc-800 text-white placeholder-zinc-700 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all uppercase font-bold tracking-wide text-sm"
                        style="font-family: 'Aniko', sans-serif;"
                        placeholder="TU@EMAIL.COM"
                    />
                </div>

                <!-- Phone -->
                <div class="space-y-1">
                    <label
                        for="leadPhone"
                        class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.2em] ml-1"
                        >WHATSAPP <span
                            class="text-[9px] text-zinc-600 opacity-60"
                            >(OPCIONAL)</span
                        ></label
                    >
                    <input
                        type="tel"
                        id="leadPhone"
                        class="w-full px-5 py-4 bg-zinc-900/40 border border-zinc-800 text-white placeholder-zinc-700 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all uppercase font-bold tracking-wide text-sm"
                        style="font-family: 'Aniko', sans-serif;"
                        placeholder="+54 9 11..."
                    />
                </div>

                <!-- Actions -->
                <div class="flex gap-4 mt-10">
                    <button
                        type="button"
                        id="cancelBtn"
                        class="flex-1 py-4 bg-zinc-900/80 text-zinc-500 font-bold hover:bg-zinc-800 hover:text-white transition-colors uppercase tracking-widest text-[10px] clip-btn border border-white/5 cursor-pointer"
                    >
                        CANCELAR
                    </button>
                    <button
                        type="submit"
                        id="submitBtn"
                        class="flex-1 py-4 bg-white text-black font-black hover:bg-accent transition-all disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-widest text-[11px] clip-btn shadow-[0_6px_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-y-1 cursor-pointer"
                    >
                        <span class="submit-text">CONTINUAR AL PAGO</span>
                        <span class="submit-loading hidden">
                            <svg
                                class="animate-spin h-5 w-5 mx-auto text-black"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </span>
                    </button>
                </div>

                <p
                    id="errorMsg"
                    class="text-red-500 text-[10px] font-black text-center hidden uppercase mt-4 tracking-widest"
                >
                </p>
            </form>
        </div>
    </div>
</div>

<style>
    .clip-btn {
        clip-path: polygon(8% 0%, 100% 0%, 92% 100%, 0% 100%);
    }
</style>

<script define:vars={{ SUPABASE_URL }}>
    const modal = document.getElementById("leadModal");
    // We target the inner card for animation
    const modalContent = modal.querySelector(".modal-card");

    const form = document.getElementById("leadForm");
    const closeBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const submitBtn = document.getElementById("submitBtn");
    const errorMsg = document.getElementById("errorMsg");

    const nameInput = document.getElementById("leadName");
    const emailInput = document.getElementById("leadEmail");
    const phoneInput = document.getElementById("leadPhone");

    let currentPlan = null;

    function openModal() {
        // 1. Unhide container
        modal.classList.remove("hidden");
        // 2. Add flex to container to enable centering
        modal.classList.add("flex");
        // 3. Lock scroll
        document.body.style.overflow = "hidden";

        // 4. Animate Content In
        requestAnimationFrame(() => {
            modalContent.classList.remove("scale-95", "opacity-0");
            modalContent.classList.add("scale-100", "opacity-100");
        });
    }

    function closeModal() {
        // 1. Animate Content Out
        modalContent.classList.remove("scale-100", "opacity-100");
        modalContent.classList.add("scale-95", "opacity-0");

        // 2. Wait for animation then hide
        setTimeout(() => {
            modal.classList.remove("flex");
            modal.classList.add("hidden");
            document.body.style.overflow = "";
            currentPlan = null;
        }, 300);
    }

    // --- Public API ---
    window.openLeadModal = (planType) => {
        currentPlan = planType;
        form.reset();
        errorMsg.classList.add("hidden");
        setLoading(false);
        openModal();
    };

    // --- Event Listeners ---
    closeBtn?.addEventListener("click", closeModal);
    cancelBtn?.addEventListener("click", closeModal);

    // Close on backdrop click
    modal?.addEventListener("click", (e) => {
        if (!e.target.closest(".modal-card")) {
            closeModal();
        }
    });

    // Close on Escape
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !modal.classList.contains("hidden")) {
            closeModal();
        }
    });

    // Form Submission
    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentPlan) return;

        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const phone = phoneInput.value.trim();

        if (!name || !email) {
            showError("Nombre y Email obligatorios.");
            return;
        }

        setLoading(true);
        errorMsg.classList.add("hidden");

        try {
            const response = await fetch(
                `${SUPABASE_URL}/functions/v1/create-preference`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        plan_type: currentPlan,
                        email: email,
                        full_name: name,
                        phone: phone,
                    }),
                },
            );

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || "Error de red");

            if (data.sandbox_init_point || data.init_point) {
                window.location.href = data.init_point;
            } else {
                throw new Error("Link no generado");
            }
        } catch (error) {
            showError(error.message || "Error inesperado.");
            setLoading(false);
        }
    });

    function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.classList.remove("hidden");
    }

    function setLoading(isLoading) {
        if (!submitBtn) return;
        submitBtn.disabled = isLoading;
        const text = submitBtn.querySelector(".submit-text");
        const loader = submitBtn.querySelector(".submit-loading");

        if (isLoading) {
            text?.classList.add("hidden");
            loader?.classList.remove("hidden");
        } else {
            text?.classList.remove("hidden");
            loader?.classList.add("hidden");
        }
    }
</script>
