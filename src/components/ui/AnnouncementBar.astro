---
/**
 * AnnouncementBar Component
 *
 * A rotative announcement bar that displays a series of messages with sleek transitions.
 * Fully customizable via props.
 */
interface Props {
    messages?: string[];
    interval?: number; // Time each message stays visible (ms)
    duration?: number; // Animation transition duration (ms)
    backgroundColor?: string;
    textColor?: string;
    highlightColor?: string;
    animationType?:
        | "slide-vertical"
        | "slide-horizontal"
        | "fade"
        | "zoom"
        | "none";
}

const {
    messages = ["Todos los métodos de pago están disponibles."],
    interval = 5000,
    duration = 600,
    backgroundColor = "var(--primary)",
    textColor = "rgba(255, 255, 255, 0.9)",
    highlightColor = "var(--accent)",
    animationType = "slide-vertical",
} = Astro.props;

// Function to parse the message for highlighting
const parseMessage = (msg: string) => {
    return msg.replace(
        /\*\*(.*?)\*\*/g,
        `<span style="color: ${highlightColor}; font-weight: 700;">$1</span>`,
    );
};

const parsedMessages = messages.map((msg) => parseMessage(msg));
const initialMessage = parsedMessages[0];
---

<div
    class="fixed inset-x-0 top-0 h-10 border-b border-white/10 grid place-items-center z-[999] overflow-hidden group"
    id="announcement-bar"
    data-messages={JSON.stringify(parsedMessages)}
    data-interval={interval}
    data-duration={duration}
    data-animation={animationType}
    style={`background-color: ${backgroundColor};`}
>
    <div class="relative w-full h-full flex items-center justify-center px-4">
        <div
            id="announcement-text"
            class="w-full text-[11px] sm:text-xs tracking-wider uppercase font-semibold m-0 p-0 text-center transition-all ease-out"
            style={`transition-duration: ${duration}ms; color: ${textColor};`}
            set:html={initialMessage}
        />

        <!-- Subtle glow effect behind text -->
        <div
            class="absolute inset-0 bg-linear-to-r from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-1000 pointer-events-none"
        >
        </div>
    </div>
</div>

<script>
    let announcementInterval: number;

    function initAnnouncementBar() {
        if (announcementInterval) {
            clearInterval(announcementInterval);
        }

        const bar = document.getElementById("announcement-bar");
        const textElement = document.getElementById("announcement-text");

        if (!bar || !textElement) return;

        const messages = JSON.parse(bar.dataset.messages || "[]");
        const interval = parseInt(bar.dataset.interval || "5000");
        const duration = parseInt(bar.dataset.duration || "600");
        const animationType = bar.dataset.animation || "slide-vertical";

        if (messages.length <= 1) return;

        let currentIndex = 0;

        const applyExitStyles = () => {
            switch (animationType) {
                case "slide-vertical":
                    textElement.style.opacity = "0";
                    textElement.style.transform = "translateY(-10px)";
                    textElement.style.filter = "blur(4px)";
                    break;
                case "slide-horizontal":
                    textElement.style.opacity = "0";
                    textElement.style.transform = "translateX(20px)";
                    textElement.style.filter = "blur(2px)";
                    break;
                case "fade":
                    textElement.style.opacity = "0";
                    textElement.style.filter = "blur(8px)";
                    break;
                case "zoom":
                    textElement.style.opacity = "0";
                    textElement.style.transform = "scale(0.95)";
                    textElement.style.filter = "blur(4px)";
                    break;
            }
        };

        const applyResetStyles = () => {
            textElement.style.transition = "none";
            switch (animationType) {
                case "slide-vertical":
                    textElement.style.transform = "translateY(10px)";
                    break;
                case "slide-horizontal":
                    textElement.style.transform = "translateX(-20px)";
                    break;
                case "fade":
                    break;
                case "zoom":
                    textElement.style.transform = "scale(1.05)";
                    break;
            }
        };

        const applyEnterStyles = () => {
            textElement.style.transition = `all ${duration}ms cubic-bezier(0.23, 1, 0.32, 1)`;
            textElement.style.opacity = "1";
            textElement.style.transform = "translate(0, 0) scale(1)";
            textElement.style.filter = "blur(0)";
        };

        const rotateMessages = () => {
            applyExitStyles();

            setTimeout(() => {
                currentIndex = (currentIndex + 1) % messages.length;
                textElement.innerHTML = messages[currentIndex];

                applyResetStyles();
                textElement.offsetHeight; // Force reflow
                applyEnterStyles();
            }, duration);
        };

        announcementInterval = setInterval(
            rotateMessages,
            interval,
        ) as unknown as number;
    }

    initAnnouncementBar();
    document.addEventListener("astro:after-swap", initAnnouncementBar);
</script>

<style>
    #announcement-bar {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    #announcement-text {
        will-change: transform, opacity, filter;
    }
</style>
